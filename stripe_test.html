<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Subscription Test - Smart Accounting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">üéØ Stripe Subscription Integration Test</h1>
                <p class="text-lg text-gray-600">Complete end-to-end testing of Stripe subscription functionality</p>
            </div>

            <!-- Authentication Status -->
            <div id="auth-status" class="mb-6 p-4 rounded-lg border">
                <h3 class="text-lg font-semibold mb-2">üîê Authentication Status</h3>
                <div id="auth-info" class="text-sm text-gray-600">Checking authentication...</div>
                <button id="auth-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="setupAuth()">
                    Setup Test Authentication
                </button>
            </div>

            <!-- Current Subscription -->
            <div id="subscription-status" class="mb-6 p-4 rounded-lg border bg-white">
                <h3 class="text-lg font-semibold mb-2">üìä Current Subscription Status</h3>
                <div id="subscription-info" class="text-sm text-gray-600">Loading...</div>
            </div>

            <!-- Available Plans -->
            <div id="plans-section" class="mb-6">
                <h3 class="text-xl font-semibold mb-4">üí≥ Available Subscription Plans</h3>
                <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Plans will be loaded here -->
                </div>
            </div>

            <!-- Test Results -->
            <div id="test-results" class="mb-6 p-4 rounded-lg border bg-gray-50">
                <h3 class="text-lg font-semibold mb-2">üìã Test Results Log</h3>
                <div id="log-container" class="max-h-64 overflow-y-auto bg-white p-3 rounded border">
                    <div class="text-sm text-gray-500">Test log will appear here...</div>
                </div>
                <button onclick="clearLog()" class="mt-2 px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
                    Clear Log
                </button>
            </div>

            <!-- Instructions -->
            <div class="p-4 rounded-lg border border-blue-200 bg-blue-50">
                <h3 class="text-lg font-semibold mb-2 text-blue-800">üß™ Testing Instructions</h3>
                <ol class="text-sm text-blue-700 space-y-1">
                    <li><strong>1.</strong> Click "Setup Test Authentication" to authenticate</li>
                    <li><strong>2.</strong> Current subscription status will load automatically</li>
                    <li><strong>3.</strong> Click "Upgrade to Platinum Plan" to test Stripe checkout creation</li>
                    <li><strong>4.</strong> A new tab will open with the Stripe checkout page</li>
                    <li><strong>5.</strong> Use test card: <code class="bg-blue-100 px-1 rounded">4242 4242 4242 4242</code>, any future expiry, any CVC</li>
                    <li><strong>6.</strong> Complete the test payment to verify webhook integration</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api/v1';
        const DEV_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzUzMzMwMTU5LCJpYXQiOjE3NTMzMjgzNTksImp0aSI6ImYzNjZmY2FhNWFmNzQ1NzQ5MzI5ZDExY2IzYTJhNzgxIiwidXNlcl9pZCI6MTN9.X_XTSeLYfgDwUE9mSA3E_sWvtatdH6foa3Jy525O5nU';
        const DEV_USER = {
            id: 13,
            email: 'test@example.com',
            username: 'testuser',
            first_name: 'Test',
            last_name: 'User'
        };

        let currentAuth = null;
        let testLog = [];

        // Utility Functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { message, type, timestamp };
            testLog.push(logEntry);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const container = document.getElementById('log-container');
            if (testLog.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500">Test log will appear here...</div>';
                return;
            }

            const logHtml = testLog.map(entry => {
                const colorClass = {
                    success: 'text-green-600',
                    error: 'text-red-600',
                    info: 'text-blue-600'
                }[entry.type] || 'text-gray-600';
                
                return `<div class="text-sm ${colorClass} mb-1">
                    <strong>[${entry.timestamp}]</strong> ${entry.message}
                </div>`;
            }).join('');
            
            container.innerHTML = logHtml;
            container.scrollTop = container.scrollHeight;
        }

        function clearLog() {
            testLog = [];
            updateLogDisplay();
        }

        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(currentAuth ? { 'Authorization': `Bearer ${currentAuth}` } : {})
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Authentication Functions
        function setupAuth() {
            localStorage.setItem('smart_accounting_token', DEV_TOKEN);
            localStorage.setItem('smart_accounting_user', JSON.stringify(DEV_USER));
            currentAuth = DEV_TOKEN;
            
            log('‚úÖ Development authentication set up successfully!', 'success');
            log(`üë§ Authenticated as: ${DEV_USER.email}`, 'info');
            
            updateAuthStatus();
            loadSubscriptionData();
        }

        function updateAuthStatus() {
            const authInfo = document.getElementById('auth-info');
            const authBtn = document.getElementById('auth-btn');
            
            if (currentAuth) {
                authInfo.innerHTML = `
                    <div class="text-green-600">‚úÖ Authenticated as: ${DEV_USER.email}</div>
                    <div class="text-sm text-gray-500">Token: ${currentAuth.substring(0, 30)}...</div>
                `;
                authBtn.textContent = 'Clear Authentication';
                authBtn.onclick = clearAuth;
            } else {
                authInfo.innerHTML = '<div class="text-red-600">‚ùå Not authenticated</div>';
                authBtn.textContent = 'Setup Test Authentication';
                authBtn.onclick = setupAuth;
            }
        }

        function clearAuth() {
            localStorage.removeItem('smart_accounting_token');
            localStorage.removeItem('smart_accounting_user');
            currentAuth = null;
            log('üßπ Authentication cleared', 'info');
            updateAuthStatus();
        }

        // Subscription Functions
        async function loadSubscriptionData() {
            if (!currentAuth) {
                log('‚ùå Authentication required', 'error');
                return;
            }

            try {
                log('üîç Loading subscription data...', 'info');
                
                const [plansData, detailsData] = await Promise.all([
                    apiRequest('/subscriptions/api/plans/'),
                    apiRequest('/subscriptions/api/details/')
                ]);

                log('‚úÖ Successfully loaded subscription data', 'success');
                
                updateSubscriptionStatus(detailsData);
                updatePlansDisplay(plansData.plans);
                
            } catch (error) {
                log(`‚ùå Failed to load subscription data: ${error.message}`, 'error');
            }
        }

        function updateSubscriptionStatus(data) {
            const container = document.getElementById('subscription-info');
            const subscription = data.subscription;
            const features = data.features;

            let statusHtml = `
                <div class="mb-3">
                    <strong>Current Plan:</strong> 
                    <span class="px-2 py-1 rounded text-sm ${subscription ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${subscription ? subscription.plan_id?.toUpperCase() || 'UNKNOWN' : 'BASIC'}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>Subscription Status:</strong> ${subscription ? subscription.status || 'active' : 'none'}
                </div>
                <div>
                    <strong>Current Features:</strong>
                    <ul class="mt-1 text-sm text-gray-600">
            `;

            Object.entries(features).forEach(([key, value]) => {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let displayValue = value;
                if (key === 'max_documents') {
                    displayValue = value === 999999 ? 'Unlimited' : value;
                } else if (typeof value === 'boolean') {
                    displayValue = value ? 'Yes' : 'No';
                }
                statusHtml += `<li>‚Ä¢ ${label}: ${displayValue}</li>`;
            });

            statusHtml += '</ul></div>';
            container.innerHTML = statusHtml;
        }

        function updatePlansDisplay(plans) {
            const container = document.getElementById('plans-grid');
            
            const planCards = Object.entries(plans).map(([planId, plan]) => {
                const isPlatinum = planId === 'platinum';
                const price = plan.price === 0 ? 'Free' : `¬£${plan.price.toFixed(2)}`;
                
                return `
                    <div class="bg-white rounded-lg border ${isPlatinum ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200'} p-6">
                        <div class="text-center mb-4">
                            <h4 class="text-xl font-semibold">${plan.name}</h4>
                            <div class="text-3xl font-bold text-blue-600 my-2">${price}</div>
                            ${plan.price > 0 ? '<div class="text-sm text-gray-500">/month</div>' : ''}
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="font-semibold mb-2">Features:</h5>
                            <ul class="text-sm space-y-1">
                                ${Object.entries(plan.features).map(([key, value]) => {
                                    const label = key === 'max_documents' 
                                        ? `${value === 999999 ? 'Unlimited' : value} documents/month`
                                        : key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    const enabled = typeof value === 'boolean' ? value : value > 0;
                                    return `<li class="${enabled ? 'text-green-600' : 'text-gray-400'}">
                                        ${enabled ? '‚úÖ' : '‚ùå'} ${label}
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>
                        
                        <button 
                            onclick="createCheckoutSession('${planId}')"
                            class="w-full py-2 px-4 rounded font-semibold ${isPlatinum 
                                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                            ${planId === 'basic' ? 'disabled' : ''}
                        >
                            ${planId === 'basic' ? 'Current Plan' : `Upgrade to ${plan.name}`}
                        </button>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = planCards;
        }

        async function createCheckoutSession(planId) {
            if (!currentAuth) {
                log('‚ùå Authentication required', 'error');
                return;
            }

            try {
                log(`üöÄ Creating Stripe checkout session for ${planId} plan...`, 'info');
                
                const result = await apiRequest('/subscriptions/api/checkout/', {
                    method: 'POST',
                    body: JSON.stringify({
                        plan_id: planId,
                        success_url: `${window.location.origin}/subscription/success.html?plan=${planId}`,
                        cancel_url: `${window.location.origin}/subscription/cancel.html?plan=${planId}`
                    })
                });

                if (result.success && result.checkout_url) {
                    log('‚úÖ Checkout session created successfully', 'success');
                    log(`üìã Session ID: ${result.session_id}`, 'info');
                    log(`üîó Opening Stripe checkout...`, 'info');
                    
                    // Open Stripe checkout in new tab
                    window.open(result.checkout_url, '_blank');
                } else {
                    throw new Error('Invalid response from checkout session creation');
                }
            } catch (error) {
                log(`‚ùå Failed to create checkout session: ${error.message}`, 'error');
            }
        }

        // Initialize
        function init() {
            // Check for existing auth
            const token = localStorage.getItem('smart_accounting_token');
            if (token) {
                currentAuth = token;
                log('üîç Found existing authentication', 'info');
            }
            
            updateAuthStatus();
            
            if (currentAuth) {
                loadSubscriptionData();
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
